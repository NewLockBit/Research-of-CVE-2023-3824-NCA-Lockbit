# Research of CVE-2023-3824 (NCA - Lockbit)
Research of CVE-2023-3824 (NCA - Lockbit) by NewLockbit (2024/03/09)

The vulnerability is related to improper buffer handling in the phar_dir_read() function in the PHP phar extension. This can lead to a buffer overflow and a buffer overread later.

The buffer overflow occurs due to the incorrect condition in the line if (to_read == 0 || count < ZSTR_LEN(str_key)). If this condition is false, then count should be greater than or equal to ZSTR_LEN(str_key). However, due to the subsequent assignment operation to_read = MIN(ZSTR_LEN(str_key), count);, the value of to_read becomes equal to ZSTR_LEN(str_key).

If the filename length (i.e., ZSTR_LEN(str_key)) is equal to the size of the php_stream_dirent buffer, then ZSTR_LEN(str_key) becomes equal to count and to_read, which leads to a buffer overflow.

The buffer overread occurs due to the line ((php_stream_dirent *) buf)->d_name[to_read + 1] = '\0';. If the size of the php_stream_dirent buffer is 4096, as is the case on most Linux systems, then the index becomes 4097, which is two bytes outside of the buf buffer. This results in a stack information leak and a buffer overflow.

In general, the vulnerability can be exploited for attacks such as "buffer overflow" or "stack information leak". This can lead to serious consequences, such as the execution of arbitrary code or the theft of confidential data.

To protect yourself from this vulnerability, it is recommended to update PHP to the latest version, in which this vulnerability has already been fixed.

You will need to write your own POC in Python, including sending a malicious PHP request and importing a file with IP addresses. Here is a sample template that you can use to write your own POC:


```
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
[EXPLOIT CODE REDACTED. Check https://t.ly/akOKg]
```

In this example, you perform the following actions:

Download the malicious PHP file malicious.php from the vulnerable website.

Download the file with IP addresses ips.txt from the vulnerable website.

Perform the attack by sending a POST request to the trigger.php script with the path to the vulnerable myarchive.phar file.

Upload the malicious PHP file malicious.php to the vulnerable website by sending a POST request to the upload.php script with the file attached.
